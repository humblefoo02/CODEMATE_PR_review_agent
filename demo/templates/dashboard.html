<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-card {
            transition: transform 0.2s;
        }
        .status-card:hover {
            transform: translateY(-2px);
        }
        .issue-item {
            border-left: 4px solid #dee2e6;
            margin-bottom: 10px;
        }
        .issue-item.severity-error { border-left-color: #dc3545; }
        .issue-item.severity-high { border-left-color: #fd7e14; }
        .issue-item.severity-medium { border-left-color: #ffc107; }
        .issue-item.severity-low { border-left-color: #20c997; }
        .issue-item.severity-info { border-left-color: #6c757d; }
        .score-display {
            font-size: 3rem;
            font-weight: bold;
        }
        .grade-display {
            font-size: 2rem;
            font-weight: bold;
        }
        .loading {
            display: none;
        }
        .loading.show {
            display: block;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-robot me-2"></i>PR Review Agent
            </a>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-4">AI-Powered PR Review</h1>
                <p class="lead">Analyze pull requests for code quality, security, and best practices</p>
            </div>
        </div>

        <!-- Analysis Form -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-search me-2"></i>Analyze Pull Request
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="analysisForm">
                            <div class="row">
                                <div class="col-md-3">
                                    <label for="server" class="form-label">Git Server</label>
                                    <select class="form-select" id="server" name="server" required>
                                        <option value="github">GitHub</option>
                                        <option value="gitlab">GitLab</option>
                                        <option value="bitbucket">Bitbucket</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="repo" class="form-label">Repository</label>
                                    <input type="text" class="form-control" id="repo" name="repo" 
                                           placeholder="owner/repo" required>
                                </div>
                                <div class="col-md-3">
                                    <label for="pr_id" class="form-label">PR/MR Number</label>
                                    <input type="number" class="form-control" id="pr_id" name="pr_id" 
                                           placeholder="123" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-play me-1"></i>Analyze
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="row loading" id="loadingIndicator">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Analyzing pull request...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" style="display: none;">
            <!-- Score Overview -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card status-card">
                        <div class="card-body text-center">
                            <div class="score-display" id="totalScore">-</div>
                            <div class="grade-display" id="grade">-</div>
                            <p class="text-muted">Overall Score</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card status-card">
                        <div class="card-body text-center">
                            <div class="h2" id="totalIssues">-</div>
                            <p class="text-muted">Issues Found</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card status-card">
                        <div class="card-body text-center">
                            <div class="h2" id="filesAffected">-</div>
                            <p class="text-muted">Files Affected</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Score Breakdown -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-pie me-2"></i>Score Breakdown
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row" id="scoreBreakdown">
                                <!-- Score breakdown will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Issues by Category -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-bug me-2"></i>Issues by Category
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row" id="issuesByCategory">
                                <!-- Issues breakdown will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Issues -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-list me-2"></i>Detailed Issues
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="detailedIssues">
                                <!-- Detailed issues will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recommendations -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-lightbulb me-2"></i>Recommendations
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="recommendations">
                                <!-- Recommendations will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Export Options -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-download me-2"></i>Export Report
                            </h5>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-outline-primary" onclick="exportReport('json')">
                                <i class="fas fa-file-code me-1"></i>Export as JSON
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('analysisForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const server = formData.get('server');
            const repo = formData.get('repo');
            const pr_id = formData.get('pr_id');
            
            // Show loading
            document.getElementById('loadingIndicator').classList.add('show');
            document.getElementById('resultsSection').style.display = 'none';
            
            try {
                const response = await fetch(`/api/analyze?server=${server}&repo=${repo}&pr_id=${pr_id}`);
                const data = await response.json();
                
                if (data.success) {
                    displayResults(data);
                } else {
                    alert('Analysis failed: ' + data.detail);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                document.getElementById('loadingIndicator').classList.remove('show');
            }
        });
        
        function displayResults(data) {
            // Update score display
            document.getElementById('totalScore').textContent = data.score.total_score;
            document.getElementById('grade').textContent = data.score.grade;
            document.getElementById('totalIssues').textContent = data.analysis.length;
            document.getElementById('filesAffected').textContent = data.score.metrics.files_affected;
            
            // Update score breakdown
            const breakdownDiv = document.getElementById('scoreBreakdown');
            breakdownDiv.innerHTML = '';
            
            for (const [category, score] of Object.entries(data.score.breakdown)) {
                const col = document.createElement('div');
                col.className = 'col-md-3 mb-2';
                col.innerHTML = `
                    <div class="d-flex justify-content-between">
                        <span>${category.charAt(0).toUpperCase() + category.slice(1)}</span>
                        <span class="badge bg-primary">${score.toFixed(1)}</span>
                    </div>
                `;
                breakdownDiv.appendChild(col);
            }
            
            // Update issues by category
            const issuesDiv = document.getElementById('issuesByCategory');
            issuesDiv.innerHTML = '';
            
            const categoryCounts = {};
            data.analysis.forEach(issue => {
                const category = issue.category || 'unknown';
                categoryCounts[category] = (categoryCounts[category] || 0) + 1;
            });
            
            for (const [category, count] of Object.entries(categoryCounts)) {
                const col = document.createElement('div');
                col.className = 'col-md-3 mb-2';
                col.innerHTML = `
                    <div class="d-flex justify-content-between">
                        <span>${category.charAt(0).toUpperCase() + category.slice(1)}</span>
                        <span class="badge bg-secondary">${count}</span>
                    </div>
                `;
                issuesDiv.appendChild(col);
            }
            
            // Update detailed issues
            const detailedDiv = document.getElementById('detailedIssues');
            detailedDiv.innerHTML = '';
            
            data.feedback.forEach(feedback => {
                const issueDiv = document.createElement('div');
                issueDiv.className = `issue-item severity-${feedback.severity}`;
                issueDiv.innerHTML = `
                    <div class="p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${feedback.file}:${feedback.line}</h6>
                                <p class="mb-1">${feedback.message}</p>
                                <small class="text-muted">${feedback.category} • ${feedback.tool}</small>
                            </div>
                            <span class="badge bg-${getSeverityColor(feedback.severity)}">${feedback.severity}</span>
                        </div>
                        ${feedback.suggestions && feedback.suggestions.length > 0 ? `
                            <div class="mt-2">
                                <small class="text-muted">Suggestions:</small>
                                <ul class="mb-0">
                                    ${feedback.suggestions.map(s => `<li>${s}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
                detailedDiv.appendChild(issueDiv);
            });
            
            // Update recommendations
            const recommendationsDiv = document.getElementById('recommendations');
            recommendationsDiv.innerHTML = '';
            
            data.score.recommendations.forEach(rec => {
                const recDiv = document.createElement('div');
                recDiv.className = 'alert alert-info';
                recDiv.textContent = rec;
                recommendationsDiv.appendChild(recDiv);
            });
            
            // Show results
            document.getElementById('resultsSection').style.display = 'block';
        }
        
        function getSeverityColor(severity) {
            const colors = {
                'error': 'danger',
                'high': 'warning',
                'medium': 'info',
                'low': 'success',
                'info': 'secondary'
            };
            return colors[severity] || 'secondary';
        }
        
        async function exportReport(format) {
            try {
                const response = await fetch(`/api/export?format=${format}`);
                const data = await response.json();
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `pr-review-report.${format}`;
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                alert('Export failed: ' + error.message);
            }
        }
    </script>
</body>
</html>
